#include "Global.xm"
#include "HBTSStatusBarView.mm"

#import <Foundation/NSDistributedNotificationCenter.h>
#import <UIKit/UIApplication+Private.h>
#import <UIKit/UIStatusBarForegroundView.h>

#pragma mark - Constructor

%ctor {
	prefsBundle = [[NSBundle bundleWithPath:@"/Library/PreferenceBundles/TypeStatus.bundle"] retain];

	[[NSNotificationCenter defaultCenter] addObserverForName:UIApplicationDidFinishLaunchingNotification object:nil queue:[NSOperationQueue mainQueue] usingBlock:^(NSNotification *notification) {
		if (![UIApplication sharedApplication].statusBar) {
			NSLog(@"TypeStatus: uh oh. no status bar. bailing out.");
			return;
		}

		UIStatusBarForegroundView *foregroundView = MSHookIvar<UIStatusBarForegroundView *>([UIApplication sharedApplication].statusBar, "_foregroundView");

		if (!foregroundView) {
			NSLog(@"TypeStatus: uh oh. no foregroundView. bailing out.");
			return;
		}

		overlayView = [[HBTSStatusBarView alloc] initWithFrame:[UIApplication sharedApplication].statusBar.frame];
		[[UIApplication sharedApplication].statusBar addSubview:overlayView];

		[[NSDistributedNotificationCenter defaultCenter] addObserverForName:HBTSClientSetStatusBarNotification object:nil queue:[NSOperationQueue mainQueue] usingBlock:^(NSNotification *notification) {
			BOOL typing = ((NSNumber *)notification.userInfo[kHBTSMessageIsTypingKey]).boolValue;
			NSTimeInterval duration = typing && ![userDefaults boolForKey:kHBTSPreferencesTypingTimeoutKey] ? kHBTSTypingTimeout : [userDefaults doubleForKey:kHBTSPreferencesOverlayDurationKey];

			if ([[NSDate date] timeIntervalSinceDate:notification.userInfo[kHBTSMessageSendDateKey]] > duration) {
				return;
			}

			[overlayView showWithType:(HBTSStatusBarType)((NSNumber *)notification.userInfo[kHBTSMessageTypeKey]).intValue name:notification.userInfo[kHBTSMessageSenderKey] timeout:duration];
		}];
	}];
}
